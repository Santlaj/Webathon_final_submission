<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Helper Portal</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-from:   #e8f0fe;
      --bg-to:     #f0fdf4;
      --card-bg:   #ffffff;
      --primary:   #4f6ef7;
      --primary-d: #3a56d4;
      --green:     #16a34a;
      --green-l:   #dcfce7;
      --green-b:   #bbf7d0;
      --red:       #dc2626;
      --red-l:     #fee2e2;
      --amber:     #d97706;
      --amber-l:   #fef3c7;
      --amber-b:   #fde68a;
      --gray-l:    #f1f5f9;
      --gray-b:    #e2e8f0;
      --text:      #0f172a;
      --muted:     #64748b;
      --soft:      #94a3b8;
      --shadow:    0 20px 48px rgba(79,110,247,0.10), 0 4px 16px rgba(0,0,0,0.06);
      --radius:    20px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: linear-gradient(145deg, var(--bg-from), var(--bg-to));
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
    .card {
      background: var(--card-bg);
      width: 100%;
      max-width: 440px;
      border-radius: var(--radius);
      padding: 28px 24px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.8);
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 22px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 800;
      color: var(--text);
      letter-spacing: -0.4px;
    }

    .card-title span {
      color: var(--primary);
    }

    /* ‚îÄ‚îÄ BADGE ‚îÄ‚îÄ */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .badge-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
    }

    .badge.offline {
      background: var(--red-l);
      color: var(--red);
    }
    .badge.offline .badge-dot { background: var(--red); }

    .badge.online {
      background: var(--green-l);
      color: var(--green);
    }
    .badge.online .badge-dot {
      background: var(--green);
      animation: blink 1.4s ease infinite;
    }

    .badge.active-job {
      background: var(--amber-l);
      color: var(--amber);
    }
    .badge.active-job .badge-dot {
      background: var(--amber);
      animation: blink 1.4s ease infinite;
    }

    @keyframes blink {
      0%,100% { opacity: 1; transform: scale(1); }
      50%      { opacity: 0.4; transform: scale(0.75); }
    }

    /* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
    .divider {
      height: 1px;
      background: var(--gray-b);
      margin: 4px 0 20px;
    }

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn-row {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
    }

    .btn {
      flex: 1;
      border: none;
      padding: 13px 16px;
      border-radius: 14px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      letter-spacing: 0.1px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 14px rgba(79,110,247,0.30);
    }
    .btn-primary:hover {
      background: var(--primary-d);
      box-shadow: 0 6px 20px rgba(79,110,247,0.40);
      transform: translateY(-1px);
    }

    .btn-danger {
      background: var(--red-l);
      color: var(--red);
      border: 1px solid #fecaca;
    }
    .btn-danger:hover {
      background: #fecaca;
      transform: translateY(-1px);
    }

    .btn-success {
      background: var(--green-l);
      color: var(--green);
      border: 1px solid var(--green-b);
      flex: 1;
    }
    .btn-success:hover {
      background: var(--green-b);
      transform: translateY(-1px);
    }

    .btn-warn {
      background: var(--amber-l);
      color: var(--amber);
      border: 1px solid var(--amber-b);
    }
    .btn-warn:hover {
      background: var(--amber-b);
      transform: translateY(-1px);
    }

    .btn-gray {
      background: var(--gray-l);
      color: var(--muted);
      border: 1px solid var(--gray-b);
    }
    .btn-gray:hover {
      background: var(--gray-b);
    }

    .btn-blue-outline {
      background: #eff6ff;
      color: var(--primary);
      border: 1px solid #bfdbfe;
    }
    .btn-blue-outline:hover {
      background: #dbeafe;
      transform: translateY(-1px);
    }

    /* ‚îÄ‚îÄ WAITING TEXT ‚îÄ‚îÄ */
    #waitingText {
      text-align: center;
      color: var(--soft);
      font-size: 13px;
      font-weight: 500;
      padding: 4px 0 2px;
    }

    /* ‚îÄ‚îÄ ACTIVE JOB STRIP ‚îÄ‚îÄ */
    .active-strip {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--amber-l);
      border: 1px solid var(--amber-b);
      border-radius: 14px;
      padding: 13px 16px;
      margin-bottom: 14px;
    }

    .active-strip-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .strip-icon {
      width: 36px; height: 36px;
      background: white;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .strip-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
    }

    .strip-sub {
      font-size: 11px;
      color: var(--amber);
      font-weight: 600;
      margin-top: 1px;
    }

    .strip-tag {
      font-size: 11px;
      font-weight: 700;
      background: white;
      color: var(--primary);
      border: 1px solid #bfdbfe;
      padding: 3px 10px;
      border-radius: 999px;
    }

    /* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
    #map {
      height: 380px;
      border-radius: 16px;
      overflow: hidden;
      margin-top: 2px;
      border: 1px solid var(--gray-b);
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    }

    /* ‚îÄ‚îÄ TRACKING HEADER ‚îÄ‚îÄ */
    .tracking-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--gray-l);
      border: 1px solid var(--gray-b);
      border-radius: 14px;
      padding: 12px 16px;
      margin-bottom: 12px;
    }

    .th-left .th-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
    }

    .th-left .th-sub {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .th-badge {
      font-size: 11px;
      font-weight: 700;
      background: #eff6ff;
      color: var(--primary);
      border: 1px solid #bfdbfe;
      padding: 4px 12px;
      border-radius: 999px;
    }

    /* ‚îÄ‚îÄ HIDDEN ‚îÄ‚îÄ */
    .hidden { display: none !important; }

    /* ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ */
    .timer-bar {
      background: var(--gray-l);
      border: 1px solid var(--gray-b);
      border-radius: 14px;
      padding: 12px 16px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .timer-icon {
      font-size: 18px;
      flex-shrink: 0;
    }

    .timer-body { flex: 1; }

    .timer-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 5px;
    }

    .timer-track {
      height: 6px;
      background: var(--gray-b);
      border-radius: 999px;
      overflow: hidden;
    }

    .timer-fill {
      height: 100%;
      border-radius: 999px;
      background: var(--primary);
      transition: width 1s linear, background 1s ease;
    }

    .timer-digits {
      font-size: 18px;
      font-weight: 800;
      color: var(--text);
      letter-spacing: -0.5px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .timer-digits.warn  { color: var(--amber); }
    .timer-digits.expired { color: var(--red); }

    /* ‚îÄ‚îÄ BOOKING COUNTDOWN RING ‚îÄ‚îÄ */
    .popup-countdown {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 14px;
    }

    .ring-wrap {
      position: relative;
      width: 52px; height: 52px;
      flex-shrink: 0;
    }

    .ring-wrap svg {
      transform: rotate(-90deg);
      width: 52px; height: 52px;
    }

    .ring-bg  { fill: none; stroke: var(--gray-b); stroke-width: 4; }
    .ring-arc {
      fill: none;
      stroke: var(--primary);
      stroke-width: 4;
      stroke-linecap: round;
      stroke-dasharray: 132; /* 2œÄ √ó r(21) ‚âà 132 */
      stroke-dashoffset: 0;
      transition: stroke-dashoffset 1s linear, stroke 0.4s;
    }

    .ring-num {
      position: absolute;
      inset: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px;
      font-weight: 800;
      color: var(--text);
    }

    .popup-countdown-text {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .popup-countdown-text b { color: var(--text); font-size: 13px; }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    .toast {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(-80px);
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 13px 20px;
      border-radius: 14px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 8px 28px rgba(0,0,0,0.14);
      z-index: 9999;
      opacity: 0;
      transition: transform 0.35s cubic-bezier(.34,1.56,.64,1), opacity 0.3s ease;
      white-space: nowrap;
      pointer-events: none;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.success { background: #fff; border: 1.5px solid var(--green-b); color: var(--green); }
    .toast.cancel  { background: #fff; border: 1.5px solid #fecaca;        color: var(--red);   }

    .toast-icon { font-size: 18px; }
    .modal {
      position: fixed; inset: 0;
      background: rgba(15,23,42,0.45);
      backdrop-filter: blur(3px);
      display: flex; align-items: center; justify-content: center;
      animation: fadeIn 0.2s ease;
      z-index: 200;
    }

    /* ‚îÄ‚îÄ MODAL BOX ‚îÄ‚îÄ */
    .modal-box {
      background: white;
      padding: 26px 24px;
      width: 90%; max-width: 340px;
      border-radius: 22px;
      box-shadow: 0 24px 56px rgba(0,0,0,0.18);
      animation: slideUp 0.28s ease;
    }

    .modal-box h2 {
      font-size: 18px;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 6px;
    }

    .modal-box p {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 18px;
      line-height: 1.65;
    }

    /* ‚îÄ‚îÄ MODAL META ‚îÄ‚îÄ */
    .modal-meta {
      background: var(--gray-l);
      border: 1px solid var(--gray-b);
      border-radius: 14px;
      padding: 12px 14px;
      margin-bottom: 18px;
      display: flex;
      flex-direction: column;
      gap: 7px;
    }

    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }

    .meta-label { color: var(--muted); font-weight: 500; }
    .meta-value { font-weight: 700; color: var(--text); }
    .meta-value.green { color: var(--green); }

    .modal-btns {
      display: flex;
      gap: 8px;
    }

    @keyframes fadeIn  { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>

<div class="card">

  <!-- HEADER -->
  <div class="card-header">
    <div class="card-title">Helper <span>Portal</span></div>
    <span id="statusBadge" class="badge offline">
      <span class="badge-dot"></span> Offline
    </span>
  </div>

  <div class="divider"></div>

  <!-- DASHBOARD VIEW -->
  <div id="dashboardView">

    <!-- Active job strip (hidden by default) -->
    <div id="activeStrip" class="active-strip hidden">
      <div class="active-strip-left">
        <div class="strip-icon">üîß</div>
        <div>
          <div class="strip-title">Active Job In Progress</div>
          <div class="strip-sub" id="stripJobType">Plumbing</div>
        </div>
      </div>
      <div class="strip-tag" id="stripTag">Plumbing</div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" onclick="goOnline()">Go Online</button>
      <button class="btn btn-danger"  onclick="goOffline()">Go Offline</button>
    </div>

    <!-- Resume + Cancel (hidden by default) -->
    <div id="activeActions" class="btn-row hidden">
      <button class="btn btn-blue-outline" onclick="openTracking()">üìç Resume Job</button>
      <button class="btn btn-warn"         onclick="cancelJob()">‚úï Cancel</button>
    </div>

    <p id="waitingText">You are offline</p>
  </div>

  <!-- TRACKING VIEW -->
  <div id="trackingView" class="hidden">

    <div class="tracking-header">
      <button class="btn btn-gray" onclick="returnToDashboard()" style="flex:0;padding:8px 14px;font-size:13px;">‚Üê Back</button>
      <div class="th-left">
        <div class="th-title">Live Tracking</div>
        <div class="th-sub" id="trackingJobSub">Service: Plumbing</div>
      </div>
      <div class="th-badge" id="trackingJobBadge">üî© Plumbing</div>
    </div>

    <!-- 15-MIN TIMER -->
    <div class="timer-bar">
      <div class="timer-icon">‚è±Ô∏è</div>
      <div class="timer-body">
        <div class="timer-label">Service Time Remaining</div>
        <div class="timer-track">
          <div class="timer-fill" id="timerFill"></div>
        </div>
      </div>
      <div class="timer-digits" id="timerDigits">15:00</div>
    </div>

    <div id="map"></div>

    <div class="btn-row" style="margin-top:14px;">
      <button class="btn btn-success" onclick="completeJob()">‚úÖ Complete Job</button>
      <button class="btn btn-warn"    onclick="cancelJob()">‚úï Cancel</button>
    </div>

  </div>

</div>

<!-- BOOKING MODAL -->
<div id="bookingPopup" class="modal hidden">
  <div class="modal-box">
    <h2>New Booking üîî</h2>

    <!-- countdown ring -->
    <div class="popup-countdown">
      <div class="ring-wrap">
        <svg viewBox="0 0 52 52">
          <circle class="ring-bg"  cx="26" cy="26" r="21"/>
          <circle class="ring-arc" cx="26" cy="26" r="21" id="ringArc"/>
        </svg>
        <div class="ring-num" id="ringNum">15</div>
      </div>
      <div class="popup-countdown-text">
        <b>Respond quickly!</b><br>
        Request auto-cancels if not accepted in time.
      </div>
    </div>

    <div class="modal-meta">
      <div class="meta-row">
        <span class="meta-label">Service</span>
        <span class="meta-value" id="popupService">üî© Plumbing</span>
      </div>
      <div class="meta-row">
        <span class="meta-label">Customer</span>
        <span class="meta-value" id="popupCustomer">Rahul M.</span>
      </div>
      <div class="meta-row">
        <span class="meta-label">Distance</span>
        <span class="meta-value" id="popupDistance">~1.2 km</span>
      </div>

    </div>
    <div class="modal-btns">
      <button class="btn btn-primary" style="flex:1" onclick="acceptBooking()">Accept</button>
      <button class="btn btn-gray"                   onclick="rejectBooking()">Decline</button>
    </div>
  </div>
</div>

<!-- CANCEL MODAL -->
<div id="cancelPopup" class="modal hidden">
  <div class="modal-box">
    <h2>Cancel Job?</h2>
    <p>Are you sure you want to cancel this job? The customer will be notified.</p>
    <div class="modal-btns">
      <button class="btn btn-danger" style="flex:1;background:#dc2626;color:white;border:none;" onclick="confirmCancel()">Yes, Cancel</button>
      <button class="btn btn-gray"                                                               onclick="dismissCancel()">Go Back</button>
    </div>
  </div>
</div>

<script>
  let gpsInterval = null;
  let watchId     = null;
  let isOnline    = false;
  let map = null, helperMarker, customerMarker, routeLine;
  let timerInterval = null;
  const TIMER_TOTAL = 15 * 60; // 15 minutes in seconds

  const CUSTOMERS = [
    'Rahul M.', 'Priya S.', 'Amit K.', 'Neha R.',
    'Suresh P.', 'Kavita D.', 'Arjun T.', 'Pooja V.'
  ];

  const DISTANCES = [
    '0.4 km', '0.8 km', '1.1 km', '1.5 km',
    '1.9 km', '2.3 km', '2.7 km', '3.2 km'
  ];

  let currentCustomer = CUSTOMERS[0];
  let currentDistance = DISTANCES[0];

  const JOBS = [
    { type: 'Plumbing',          icon: 'üîß' },
    { type: 'Appliance Repair',  icon: 'üîå' },
    { type: 'House Help',        icon: 'üè†' },
    { type: 'Electronics',       icon: 'üì∫' },
    { type: 'Carpentry',         icon: 'ü™ö' },
    { type: 'Electrical Work',   icon: '‚ö°' },
  ];

  let currentJob = JOBS[0]; // active job for current session

  function pickRandomJob() {
    currentJob      = JOBS[Math.floor(Math.random() * JOBS.length)];
    currentCustomer = CUSTOMERS[Math.floor(Math.random() * CUSTOMERS.length)];
    currentDistance = DISTANCES[Math.floor(Math.random() * DISTANCES.length)];
  }

  const $ = id => document.getElementById(id);

  /* ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ */
  window.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('jobActive') === 'true') {
      isOnline = true;
      updateBadge('active');
      setWaitingText('');
      showActiveJobUI(true);
      // Show remaining time in the strip even before tracking opens
      tickTimer();
    }
  });

  /* ‚îÄ‚îÄ ONLINE / OFFLINE ‚îÄ‚îÄ */
  function goOnline() {
    if (localStorage.getItem('jobActive') === 'true') {
      $('activeJobPopup').classList.remove('hidden');
      return;
    }
    if (isOnline) return;
    isOnline = true;
    updateBadge('online');
    setWaitingText('Waiting for a booking request‚Ä¶');
    startGPS();
    setTimeout(() => { if (isOnline) showBooking(); }, 4000);
  }

  function goOffline() {
    if (localStorage.getItem('jobActive') === 'true') {
      $('activeJobPopup').classList.remove('hidden');
      return;
    }
    isOnline = false;
    updateBadge('offline');
    setWaitingText('You are offline');
    stopGPS();
    clearWatch();
  }

  /* ‚îÄ‚îÄ BADGE ‚îÄ‚îÄ */
  function updateBadge(state) {
    const el = $('statusBadge');
    const states = {
      offline:  ['badge offline',    'Offline'],
      online:   ['badge online',     'Online'],
      active:   ['badge active-job', 'Active Job'],
    };
    const [cls, lbl] = states[state];
    el.className = cls;
    el.innerHTML = `<span class="badge-dot"></span> ${lbl}`;
  }

  function setWaitingText(txt) {
    $('waitingText').textContent = txt;
  }

  /* ‚îÄ‚îÄ ACTIVE JOB UI (strip + actions on dashboard) ‚îÄ‚îÄ */
  function showActiveJobUI(show) {
    const jobType  = localStorage.getItem('jobType')      || currentJob.type;
    const jobIcon  = localStorage.getItem('jobIcon')      || currentJob.icon;
    const custName = localStorage.getItem('custName')     || '';
    const custDist = localStorage.getItem('custDistance') || '';
    if (show) {
      $('activeStrip').classList.remove('hidden');
      $('activeActions').classList.remove('hidden');
      $('waitingText').textContent  = '';
      $('stripJobType').textContent = (custName ? custName + ' ¬∑ ' : '') + (custDist ? '~' + custDist : '');
      $('stripTag').textContent     = jobIcon + ' ' + jobType;
    } else {
      $('activeStrip').classList.add('hidden');
      $('activeActions').classList.add('hidden');
    }
  }

  /* ‚îÄ‚îÄ GPS ‚îÄ‚îÄ */
  function startGPS() {
    gpsInterval = setInterval(() => {
      navigator.geolocation.getCurrentPosition(pos => {
        localStorage.setItem('helperLat', pos.coords.latitude);
        localStorage.setItem('helperLng', pos.coords.longitude);
      });
    }, 5000);
  }

  function stopGPS()   { clearInterval(gpsInterval); }
  function clearWatch() {
    if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
  }

  /* ‚îÄ‚îÄ BOOKING ‚îÄ‚îÄ */
  const BOOKING_TIMEOUT = 15; // seconds to accept before auto-cancel
  let bookingCountdown  = null;
  let bookingSecsLeft   = BOOKING_TIMEOUT;

  function showBooking() {
    pickRandomJob();
    $('popupService').textContent  = `${currentJob.icon} ${currentJob.type}`;
    $('popupCustomer').textContent = currentCustomer;
    $('popupDistance').textContent = `~${currentDistance}`;
    $('bookingPopup').classList.remove('hidden');

    navigator.geolocation.getCurrentPosition(pos => {
      localStorage.setItem('custLat',      pos.coords.latitude  + 0.01);
      localStorage.setItem('custLng',      pos.coords.longitude + 0.01);
      localStorage.setItem('custName',     currentCustomer);
      localStorage.setItem('custDistance', currentDistance);
    });

    // reset and start the ring countdown
    bookingSecsLeft = BOOKING_TIMEOUT;
    renderRing(bookingSecsLeft);
    clearInterval(bookingCountdown);
    bookingCountdown = setInterval(() => {
      bookingSecsLeft--;
      renderRing(bookingSecsLeft);
      if (bookingSecsLeft <= 0) {
        clearInterval(bookingCountdown);
        autoCancelBooking();
      }
    }, 1000);
  }

  function renderRing(secs) {
    const total   = BOOKING_TIMEOUT;
    const pct     = secs / total;              // 1 ‚Üí 0
    const circum  = 132;                       // 2œÄ √ó 21
    const offset  = circum * (1 - pct);       // drain clockwise

    const arc = $('ringArc');
    const num = $('ringNum');

    arc.style.strokeDashoffset = offset;
    num.textContent = Math.max(0, secs);

    // colour shift: blue ‚Üí amber (‚â§7s) ‚Üí red (‚â§3s)
    if (secs <= 3) {
      arc.style.stroke = 'var(--red)';
      num.style.color  = 'var(--red)';
    } else if (secs <= 7) {
      arc.style.stroke = 'var(--amber)';
      num.style.color  = 'var(--amber)';
    } else {
      arc.style.stroke = 'var(--primary)';
      num.style.color  = 'var(--text)';
    }
  }

  function autoCancelBooking() {
    $('bookingPopup').classList.add('hidden');
    setWaitingText('Request timed out ‚Äî looking for new jobs‚Ä¶');
    // stay online and wait for next booking after a short pause
    setTimeout(() => {
      if (isOnline) {
        setWaitingText('Waiting for a booking request‚Ä¶');
        setTimeout(() => { if (isOnline) showBooking(); }, 4000);
      }
    }, 2000);
  }

  function stopBookingCountdown() {
    clearInterval(bookingCountdown);
    bookingCountdown = null;
  }

  function acceptBooking() {
    stopBookingCountdown();
    $('bookingPopup').classList.add('hidden');
    localStorage.setItem('jobActive',    'true');
    localStorage.setItem('jobType',      currentJob.type);
    localStorage.setItem('jobIcon',      currentJob.icon);
    localStorage.setItem('jobStart',     Date.now());
    localStorage.setItem('custName',     currentCustomer);
    localStorage.setItem('custDistance', currentDistance);
    updateBadge('active');
    showActiveJobUI(true);
    openTracking();
  }

  function rejectBooking() {
    stopBookingCountdown();
    $('bookingPopup').classList.add('hidden');
    goOffline();
  }

  /* ‚îÄ‚îÄ TRACKING ‚îÄ‚îÄ */
  function openTracking() {
    const jobType = localStorage.getItem('jobType') || currentJob.type;
    const jobIcon = localStorage.getItem('jobIcon') || currentJob.icon;

    $('trackingJobSub').textContent   = 'Service: ' + jobType;
    $('trackingJobBadge').textContent = jobIcon + ' ' + jobType;

    $('dashboardView').classList.add('hidden');
    $('trackingView').classList.remove('hidden');

    startTimer();

    const custLat = parseFloat(localStorage.getItem('custLat'));
    const custLng = parseFloat(localStorage.getItem('custLng'));
    const custPos = [custLat, custLng];

    if (!map) {
      // First time ‚Äî init the map after the view is visible
      setTimeout(() => {
        map = L.map('map').setView(custPos, 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        customerMarker = L.marker(custPos)
          .addTo(map).bindPopup('<b>Customer</b>').openPopup();

        helperMarker = L.marker(custPos)
          .addTo(map).bindPopup('<b>You</b>');

        routeLine = L.polyline([custPos, custPos], {
          color: '#4f6ef7', weight: 3, dashArray: '7 5', opacity: 0.8
        }).addTo(map);

        beginWatch(custPos);
      }, 100);
    } else {
      // Resuming after Back ‚Äî force Leaflet to recalculate size, then restart watch
      setTimeout(() => {
        map.invalidateSize();
        map.setView(custPos, 14);
        beginWatch(custPos);
      }, 200);
    }
  }

  function beginWatch(custPos) {
    clearWatch();
    watchId = navigator.geolocation.watchPosition(pos => {
      const hp = [pos.coords.latitude, pos.coords.longitude];
      helperMarker.setLatLng(hp);
      routeLine.setLatLngs([custPos, hp]);
      map.panTo(hp);
    }, err => console.error(err), { enableHighAccuracy: true });
  }

  /* ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ */
  function startTimer() {
    clearInterval(timerInterval);
    tickTimer();
    timerInterval = setInterval(tickTimer, 1000);
  }

  function tickTimer() {
    const start   = parseInt(localStorage.getItem('jobStart') || Date.now());
    const elapsed = Math.floor((Date.now() - start) / 1000);
    const left    = Math.max(0, TIMER_TOTAL - elapsed);

    const mins = String(Math.floor(left / 60)).padStart(2, '0');
    const secs = String(left % 60).padStart(2, '0');
    const pct  = (left / TIMER_TOTAL) * 100;

    const digits = $('timerDigits');
    const fill   = $('timerFill');

    digits.textContent = `${mins}:${secs}`;
    fill.style.width   = `${pct}%`;

    if (left <= 60) {
      fill.style.background = 'var(--red)';
      digits.className      = 'timer-digits expired';
    } else if (left <= 300) {
      fill.style.background = 'var(--amber)';
      digits.className      = 'timer-digits warn';
    } else {
      fill.style.background = 'var(--primary)';
      digits.className      = 'timer-digits';
    }

    if (left === 0) {
      clearInterval(timerInterval);
      stopTimer();
      clearActiveJob();
      $('trackingView').classList.add('hidden');
      $('dashboardView').classList.remove('hidden');
      showToast('Job cancelled due to timeout.', 'cancel', '‚è∞');
      isOnline = false;
      updateBadge('offline');
      setWaitingText('You are offline');
    }
  }

  function stopTimer() {
    clearInterval(timerInterval);
    timerInterval = null;
  }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  let toastTimer = null;
  function showToast(msg, type = 'success', icon = '‚úÖ') {
    const el = $('toast');
    $('toastIcon').textContent = icon;
    $('toastMsg').textContent  = msg;
    el.className = `toast ${type} show`;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { el.classList.remove('show'); }, 3000);
  }

  /* ‚îÄ‚îÄ MAP COVER (map renders above z-index, must hide it behind modals) ‚îÄ‚îÄ */
  function hideMap()  { const m = $('map'); if (m) m.style.visibility = 'hidden'; }
  function showMap()  { const m = $('map'); if (m) m.style.visibility = 'visible'; }

  /* ‚îÄ‚îÄ COMPLETE ‚îÄ‚îÄ */
  function completeJob()    { hideMap(); $('completePopup').classList.remove('hidden'); }
  function dismissComplete(){ showMap(); $('completePopup').classList.add('hidden'); }

  function confirmComplete() {
    showMap();
    $('completePopup').classList.add('hidden');
    stopTimer();
    clearActiveJob();
    $('trackingView').classList.add('hidden');
    $('dashboardView').classList.remove('hidden');
    showToast('Job completed successfully!', 'success', '‚úÖ');
    isOnline = false;
    updateBadge('offline');
    setWaitingText('You are offline');
  }

  /* ‚îÄ‚îÄ CANCEL ‚îÄ‚îÄ */
  function cancelJob()     { hideMap(); $('cancelPopup').classList.remove('hidden'); }
  function dismissCancel() { showMap(); $('cancelPopup').classList.add('hidden'); }

  function confirmCancel() {
    showMap();
    $('cancelPopup').classList.add('hidden');
    stopTimer();
    clearActiveJob();
    $('trackingView').classList.add('hidden');
    $('dashboardView').classList.remove('hidden');
    showToast('Job has been cancelled.', 'cancel', '‚úï');
    goOffline();
  }

  /* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
  function clearActiveJob() {
    localStorage.removeItem('jobActive');
    localStorage.removeItem('custLat');
    localStorage.removeItem('custLng');
    localStorage.removeItem('jobType');
    localStorage.removeItem('jobIcon');
    localStorage.removeItem('jobStart');
    localStorage.removeItem('custName');
    localStorage.removeItem('custDistance');
    clearWatch();
    stopGPS();
    map = null;
    showActiveJobUI(false);
  }

  function returnToDashboard() {
    clearWatch();
    stopTimer();
    $('trackingView').classList.add('hidden');
    $('dashboardView').classList.remove('hidden');
    showActiveJobUI(true);
  }
</script>

<!-- ACTIVE JOB WARNING MODAL -->
<div id="activeJobPopup" class="modal hidden">
  <div class="modal-box">
    <h2>Job In Progress üîß</h2>
    <p>You already have an active job. Please complete or cancel it before taking another action.</p>
    <div class="modal-btns">
      <button class="btn btn-primary" style="flex:1" onclick="$('activeJobPopup').classList.add('hidden'); openTracking()">Go to Job</button>
      <button class="btn btn-gray" onclick="$('activeJobPopup').classList.add('hidden')">Dismiss</button>
    </div>
  </div>
</div>

<!-- COMPLETE CONFIRM MODAL -->
<div id="completePopup" class="modal hidden">
  <div class="modal-box">
    <h2>Complete Job?</h2>
    <p>Are you sure the service is done? This will mark the job as completed.</p>
    <div class="modal-btns">
      <button class="btn btn-success" style="flex:1;background:var(--green);color:white;border:none;" onclick="confirmComplete()">Yes, Complete</button>
      <button class="btn btn-gray" onclick="dismissComplete()">Go Back</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast">
  <span class="toast-icon" id="toastIcon"></span>
  <span id="toastMsg"></span>
</div>

</body>
</html>